---
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---


```{r setup, include=FALSE}

################################################################################
###
###  This markdown report must be rendered from within from STATION_SUMMARY.R
###  as that is where some of the initial parameters are defined
###
################################################################################


knitr::opts_chunk$set(
  echo = F,
  results = F,
  message = F,
  fig.align = 'right'
)

library(motus)
library(tidyverse)
library(data.table)
library(DT)

# load helper functions
source(r'(C:\GitHub\motus\helper_functions.R)')

outdir <-remoted(outdir)

```


```{r get detection summary, message = F, results = F, warning = F}

# if on BSC network, get the most recent list of receivers
# from the DB; otherwise grab the most recent local file
# TODO make function that queries the db and saves a local file
if (bsc_network == T) {
  con <- connect_to_db()
  all_recv_deps <-
    DBI::dbGetQuery(con, 'select * from vwBase_receivers_deployments')
} else
  all_recv_deps <- all_deps() # grab the most recent local file


# create list of all deployments with this site name and project
# NOTE: the exact name is needed
site_deploys <-
  all_recv_deps %>% filter(grepl(paste0('^', site, '$'), siteName),
                           grepl(proj, recvProjectID))


# get unique tag_deployID's from det_taghits_daily if specified
if (data == 1) {
  if (bsc_network == F)
    stop('Not on BSC network')
  # TODO should also just test to see if the connection can be established before moving on

  query <-
    paste0(
            'select tag_deploy_id, [date], n_hits, a.tag_id, english_name, test
      from det_taghits_daily a
      left join tags_deployments b on b.id = a.tag_deploy_id
      left join lk_species c on c.species_id = b.species_id
      where sensor_deploy_id in (',
      toString(unique(site_deploys$recvDeployID)),
      ')'
          )
  daily_summary <- DBI::dbGetQuery(con, query)
  
  summary <- daily_summary %>%
    filter(test != 1) %>%
    group_by('tagDeployID' = tag_deploy_id) %>%
    summarise(
      'Species' = english_name,
      'First date detected' = min(date),
      'map_link' = paste0(
        'https://motus.org/data/track?tagDeploymentId=',
        tag_deploy_id),
      'View on Motus.org' = paste0('<a href="',
        map_link,
        '" target="_blank">View on Motus.org</a>'
      )
    ) %>%
    slice_max(order_by = 'First date detected') %>% 
    arrange(desc('First date detected'))
} else {
  if (data == 2) {
    motus_login()
    download_site_data(site, proj)
  }
  # get the most recent allruns RDS file for the site
  # This is a folder that contains only allruns files for sites, appended with the date
  # so the most recent one is the last in an alphabetical list
  rds_file <-
    max(gtools::mixedsort(list.files(
      path = paste0(outdir, 'site_allruns/'),
      pattern = site,
      full.names = T
    )))
  
  allruns <- as.data.table(read_rds(rds_file))
  
  # remove runs shorter than 4 as well as Test tags
  # and any tag without a species
  # TODO: should filter out those with motusFilter == 0 too
  goodruns <- allruns %>%
    filter(runLen > 3,
           !is.na(speciesEN),
           motusFilter != 0,
           tagDeployTest == 0 | is.na(tagDeployTest))
  summary <- summarize_runs(goodruns) %>%
    mutate(
      'Species' = speciesEN,
      'First date detected' = format(first_date, '%Y-%m-%d'),
      'View on Motus.org' = paste0(
        '<a href="',
        map_link,
        '" target="_blank">View on Motus.org</a>'
      )
    ) %>%
    arrange(desc('First date detected'))
  
}

# remove any tag_deploy_IDs that have been flagged
summary <- summary %>%
  filter(!(tagDeployID %in% to_remove))

```


```{r dates and location of station deployments}

# get the first deployment for this site
first_deploy <- site_deploys[site_deploys$tsStart ==  min(site_deploys$tsStart), ]

lat <- first_deploy$latitude
lon <- first_deploy$longitude
latlon <- paste0('http://www.openstreetmap.org/?mlat=', lat, '&mlon=', lon, '&zoom=7')

```


<br>

::: {style="display: flex;"}
<div>

### Station: `r site`

Location: <a href= `r latlon`>`r lat`, `r lon`</a>

Start Date: `r format(as.Date(first_deploy$dtStart), '%B %d, %Y')`

Report Date: `r format(Sys.Date(), '%B %d, %Y')`

Number of species detected: `r length(unique(summary$Species))`

Number of individuals detected: `r nrow(summary)`

</div>

::: {style="margin-left: auto"}
![](D:/OneDrive/R/StationSummary/logo.png)
:::
:::

<br>

<br>

The table below summarizes all tagged animals that have been detected at this station during its operation. In an effort to remove false positives (where background radio static can resemble the signature of a tag) only tags whose signals were detected at least four consecutive times are included in this summary. Click on the link to view more details about each tag deployment on the Motus website, such as where it was tagged, the project that tagged it, as well as an overview of all the other stations that have detected this same tag.

<br>

```{r summarize good tags, fig.keep=T, fig.show=T, results=T}
datatable(summary[, c('Species', 'First date detected', 'View on Motus.org')],
          escape = F)
          
```

<br>

This map shows all the same animals as the table above, but displays all the additional stations where each of the tagged animals has been detected. Where the speed travelled between two stations seems plausible, a simplified movement path has been drawn to illustrate the distance and direction travelled. Click on a track line or point for a popup containing a link to that tag on the Motus website.

<br>

```{r get taghits_tracks, echo=F, results=T, message=F, eval=T, fig.show=T, warning=F}
# define taghits_tracks file
# don't pass this in if on the HQ server and can download this directly from the db
taghits_file <- paste0(outdir, 'taghits_tracks/', site, '_taghits_tracks.csv')

# function to get the most recent taghits_tracks 
get_taghits_tracks <- function(summary){
  # construct the query to get the data from det_taghits_tracks
  query <- paste0('select * from det_taghits_tracks where tagDeployId in (',
                  toString(summary$tagDeployID), ')')  
  
  # try to connect to the database
  tryCatch({
    db <- connect_to_db()
    taghits_tracks <- as.data.table(DBI::dbGetQuery(db, query)) %>%
      mutate(begin_s = as.POSIXct(begin_s, tz = 'UTC', origin = '1970-01-01'),
             end_s = as.POSIXct(end_s, tz = 'UTC', origin = '1970-01-01'))
    write.csv(taghits_tracks, taghits_file)
    }, error = function(e) {
    message(query)
    clipr::write_clip(query) # writes the query to the clipboard for easy pasting into SSMS
    invisible(readline(prompt = 'Use query in remote desktop. \nCopy results with headers. \nPress enter when ready. '))
    taghits_tracks <- clipr::read_clip_tbl() # takes the output (with headers!) from the SQL query
    write.csv(taghits_tracks, taghits_file)
    })
}

# get the most recent taghits_tracks file if on the network 
# if not on the network, it will make getting the most recent data from the remote desktop easier
if (tracks_from_db == T){
  get_taghits_tracks(summary)
}


```

```{r generate and view the map, fig.keep=T, results=T, message=F, eval=T, fig.show=T, warning=F}
# create the map
map <- map_tracks(summary, taghits_file)

# view the map
map

```

<br> <br>

::: {style="text-align: center;"}
*Thank you for supporting the Motus Wildlife Tracking System*

*A program of Birds Canada in partnership with collaborating individuals and organizations*
:::

<br>
