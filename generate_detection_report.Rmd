---
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}

################################################################################
###
###  This markdown report must be rendered from within from DetectionReport.R
###  as that is where some of the initial parameters are defined
###
################################################################################


knitr::opts_chunk$set(
  echo = F,
  results = F,
  message = F,
  fig.align = 'right'
)

library(motus)
library(tidyverse)
library(data.table)
library(DT)

# load helper functions
source('C:/GitHub/motus_scripts/helper_functions.R')

outdir <-remoted(outdir)

```

```{r r get detection summary, message = F, results = F, warning = F}

# summarize by stations
if (summarize_by == 1){
  
  # create list of all deployments with the desired station ID site name and project
  site_deploys <- all_recv_deps %>%
  filter(station_id == station)
  
  query_condition <- paste0(
    'where sensor_deploy_id in (',
    toString(unique(site_deploys$recv_deploy_id)),
    ')')

# summarize by project tags
} else if (summarize_by == 2){
 
  query_condition <- paste0('where d.project_id = ', project)
  
# summarize by custom list of tags
} else if (summarize_by == 3){
  
  query_condition <- q
}
  

query <-
paste0(
'select 
  tag_deploy_id, 
  a.tag_id, 
  sensor_deploy_id,
  d.period as burst_interval,
  mfg_id,
  [date],
  project_id,
  project_name,
  n_hits, 
  english_name, 
  test
from det_taghits_daily a
  left join tags_deployments b on b.id = a.tag_deploy_id
  left join lk_species c on c.species_id = b.species_id
  left join tags d on d.id = b.tag_id
  left join projects e on e.id = d.project_id ',
query_condition
)

db <- connect_to_db()
daily_summary <- DBI::dbGetQuery(db, query)

summary <- daily_summary %>%
filter(test != 1) %>%
group_by('tagDeployID' = tag_deploy_id) %>%
summarise(
  'Species' = english_name,
  'First date detected' = min(date),
  mfg_id,
  burst_interval,
  project_id,
  project_name,
  'map_link' = paste0(
    'https://motus.org/data/track?tagDeploymentId=',
    tag_deploy_id),
  'View on Motus.org' = paste0('<a href="',
    map_link,
    '" target="_blank">View on Motus.org</a>'
  )
) %>%
slice(n = 1) %>% 
ungroup() %>% 
arrange(desc(`First date detected`))

# remove any tag_deploy_IDs that have been flagged
summary <- summary %>%
  filter(!(tagDeployID %in% to_remove))


```

```{r dates and titles}

if (summarize_by == 1){
  
  # Station name
  line1 <- paste0('Station: ', name)
  
  # get the first deployment for this site
  first_deploy <- site_deploys[site_deploys$dt_start ==  min(site_deploys$dt_start), ]
  line2 <- paste0('Start Date: ', format(as.Date(first_deploy$dt_start), '%B %d, %Y'))
  
  # get the station location
  lat <- first_deploy$station_lat
  lon <- first_deploy$station_lon
  latlon <- paste0('http://www.openstreetmap.org/?mlat=', lat, '&mlon=', lon, '&zoom=7')
  
  line6 <- paste0('Location: <a href= ', latlon, '>', lat, ', ', lon, '</a>')

} else if (summarize_by == 2){
  
  line1 <- paste0('Project ', project)
  
  line2 <- paste0('First detection: ', min(summary$`First date detected`))
  
  line6 <- ''
  
} else if (summarize_by == 3){
  
  line1 <- 'Motus report'
  
  line2 <- paste0('First detection: ', min(summary$`First date detected`))
  
  line6 <- ''
  
}
```

<br>

::: {style="display: flex;"}
<div>

### `r line1`

`r line2`

Report Date: `r format(Sys.Date(), '%B %d, %Y')`

Number of species detected: `r length(unique(summary$Species))`

Number of individuals detected: `r nrow(summary)`

`r line6`

</div>

::: {style="margin-left: auto"}
![](C:/GitHub/detection_report/logo.png)
:::
:::

<br>

<br>

The table below summarizes all tagged animals that have been detected at this station during its operation. In an effort to remove false positives (where background radio static can resemble the signature of a tag) only tags whose signals were detected at least four consecutive times are included in this summary. Click on the link to view more details about each tag deployment on the Motus website, such as where it was tagged, the project that tagged it, as well as an overview of all the other stations that have detected this same tag.

<br>

```{r summarize good tags, fig.keep=T, fig.show=T, results=T}
datatable(summary[, c('Species', 'First date detected', 'View on Motus.org')],
          escape = F)
```

<br>

This map shows all the same animals as the table above, but displays all the additional stations where each of the tagged animals has been detected. Where the speed travelled between two stations seems plausible, a simplified movement path has been drawn to illustrate the distance and direction travelled. Click on a track line or point for a popup containing a link to that tag on the Motus website.

<br>

```{r get taghits_tracks, echo=F, results=T, message=F, eval=T, fig.show=T, warning=F}
# define taghits_tracks file
# don't pass this in if on the HQ server and can download this directly from the db
taghits_file <- paste0(outdir, 'taghits_tracks/', name, '_taghits_tracks.csv')


# function to get the most recent taghits_tracks 
get_taghits_tracks <- function(summary){
  # construct the query to get the data from det_taghits_tracks
  query <- paste0('select * from det_taghits_tracks where tagDeployId in (',
                  toString(summary$tagDeployID), ')')  
  
  # try to connect to the database
  tryCatch({
    db <- connect_to_db()
    taghits_tracks <- as.data.table(DBI::dbGetQuery(db, query)) %>%
      mutate(begin_s = as.POSIXct(begin_s, tz = 'UTC', origin = '1970-01-01'),
             end_s = as.POSIXct(end_s, tz = 'UTC', origin = '1970-01-01'))
    write.csv(taghits_tracks, taghits_file)
    }, error = function(e) {
    message(query)
    clipr::write_clip(query) # writes the query to the clipboard for easy pasting into SSMS
    invisible(readline(prompt = 'Use query in remote desktop. \nCopy results with headers. \nPress enter when ready. '))
    taghits_tracks <- clipr::read_clip_tbl() # takes the output (with headers!) from the SQL query
    write.csv(taghits_tracks, taghits_file)
    })
}

# get the most recent taghits_tracks file if on the network 
# if not on the network, it will make getting the most recent data from the remote desktop easier
# 

if (toString(summary$tagDeployID) != '') {
      if (tracks_from_db == T){
        get_taghits_tracks(summary)
  }
} else stop('There are either no deployments or no tags')
```

```{r generate and view the map, fig.keep=T, results=T, message=F, eval=T, fig.show=T, warning=F}
# create the map
map <- map_tracks(summary, taghits_file)

# view the map
map
```

<br> <br>

::: {style="text-align: center;"}
*Thank you for supporting the Motus Wildlife Tracking System*

*A program of Birds Canada in partnership with collaborating individuals and organizations*
:::

<br>
