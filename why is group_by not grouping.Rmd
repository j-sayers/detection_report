---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=T}
library(dplyr)

```

```{r summary function}
summary <- function(daily_summary){
  s <- daily_summary %>%
    filter(test != 1) %>%
    group_by('tagDeployID' = tag_deploy_id) %>%
    summarise(
      'Species' = english_name,
      'First date detected' = min(date),
      mfg_id,
      burst_interval,
      project_id,
      project_name,
      'map_link' = paste0(
        'https://motus.org/data/track?tagDeploymentId=',
        tag_deploy_id),
      'View on Motus.org' = paste0('<a href="',
                                   map_link,
                                   '" target="_blank">View on Motus.org</a>'
      ), .groups = 'keep'
    ) %>%
    arrange(`First date detected`) %>% 
    slice_head() 
  s
}
```

Load data from output CSV's. This is the results of a database query of the taghits_daily table for a particular station. The only difference is the `where station_id =` clause.

```{r brighton}
brighton <- read.csv('daily_summary_br.csv') %>% as_tibble()
brighton
```

```{r maple leaf}
maple_leaf <- read.csv('daily_summary_ml.csv') %>% as_tibble()
maple_leaf
```

Summarize Brighton first

```{r}
br_summary <- summary(brighton)
brighton
```

Results as expected. The data was grouped by tagDeployID and the first occurrence of each group sliced for the first date detected. Result is a grouped_df.

```{r}
is_grouped_df(br_summary)
```

```{r sumamrize maple leaf}
ml_summary <- summary(maple_leaf)
ml_summary
```

Only one record despite there being 5 valid detections. When I look closer it becomes clear that the output is not a grouped_df as expected, so only one record was sliced.

```{r}
is_grouped_df(ml_summary)
```

By why the hell is not a grouped_df?! The input data look (and should be) identical. I'm at a loss.

If either of you have any suggestions I'm all ears!

NOTE: it was the `.groups = 'keep'` argument in `summarize()`
